@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager

<div id="subscribePopup" class="subscribePopupClass" hidden="@subscribeHidden">
    <div id="centerPane">
        <h2>SUBSCRIBE TO CompanioNita™</h2>
        
        @if (_processing)
        {
            <div class="loading-indicator">Processing...</div>
        }
        else
        {
            @ChildContent
            @if (ChildContent is null)
            {
                <div>
                    <h3>Unlock CompanioNita AI Features</h3>
                    <p>To use CompanioNita AI services, you need an active subscription.</p>
                    <p>This feature is currently under development.</p>
                    <br />
                    <p>Please check back soon for subscription options!</p>
                </div>
            }
        }

        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="error-message">@_errorMessage</div>
        }
        else if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="success-message">@_successMessage</div>
        }
        else
        {
            <div class="success-message">&nbsp;</div>
        }

        <div class="button-container">
            @ButtonContent
            @if (ButtonContent is null)
            {
                <button @onclick="Close" class="blueButton">OK</button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnSubscribeFinished { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public RenderFragment? ButtonContent { get; set; }

    protected bool subscribeHidden = true;
    protected bool _processing = false;
    protected string _errorMessage = "";
    protected string _successMessage = "";

    public virtual async Task ShowSubscribe()
    {
        _errorMessage = "";
        _successMessage = "";
        _processing = false;
        subscribeHidden = false;
        await InvokeAsync(StateHasChanged);
    }

    public async Task HideSubscribe()
    {
        subscribeHidden = true;
        await OnSubscribeFinished.InvokeAsync();
    }

    protected virtual async Task Close()
    {
        await HideSubscribe();
    }

    protected void SetProcessing(bool processing)
    {
        _processing = processing;
        StateHasChanged();
    }

    protected void SetError(string message)
    {
        _errorMessage = message;
        _successMessage = "";
        StateHasChanged();
    }

    protected void SetSuccess(string message)
    {
        _successMessage = message;
        _errorMessage = "";
        StateHasChanged();
    }
}
