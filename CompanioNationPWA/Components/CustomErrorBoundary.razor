@inherits ErrorBoundaryBase
@inject CompanioNationSignalRClient SignalRClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@code {
    private DotNetObjectReference<CustomErrorBoundary>? _objectReference;
    private IJSObjectReference? _module;
    private Task? _jsRegistrationTask;
    private bool _isDisposed;

    protected override Task OnInitializedAsync()
    {
        _objectReference ??= DotNetObjectReference.Create(this);
        NavigationManager.LocationChanged += OnLocationChanged;
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _isDisposed)
        {
            return;
        }

        _jsRegistrationTask ??= RegisterObjectReferenceAsync();

        try
        {
            await _jsRegistrationTask;
        }
        catch (ObjectDisposedException)
        {
        }
        catch (JSDisconnectedException)
        {
        }
    }

    private async Task RegisterObjectReferenceAsync()
    {
        _module ??= await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/Components/CustomErrorBoundary.razor.js");

        if (_isDisposed || _objectReference is null)
        {
            return;
        }

        await _module.InvokeVoidAsync("setObjectReference", _objectReference);
    }

    protected override async Task OnErrorAsync(Exception exception)
    {
        try
        {
            Console.Error.WriteLine(exception);
            await SignalRClient.LogError(exception);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SERIOUS RECURSIVE ERROR IN OnErrorAsync!!!   {ex}");
        }
    }

    private void ResetError()
    {
        Recover();
    }

    [JSInvokable("HandleJavaScriptError")]
    public async Task HandleJavaScriptError(string errorMessage)
    {
        try
        {
            Console.Error.WriteLine($"JavaScript error: {errorMessage}");
            await SignalRClient.LogError(errorMessage);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SERIOUS RECURSIVE ERROR IN HandleJavaScriptError!!!   {ex}");
        }
    }

    private void OnLocationChanged(object sender, LocationChangedEventArgs e)
    {
        ResetError();
    }

    public async ValueTask DisposeAsync()
    {
        if (_isDisposed)
        {
            return;
        }

        _isDisposed = true;
        NavigationManager.LocationChanged -= OnLocationChanged;

        if (_jsRegistrationTask is not null)
        {
            try
            {
                await _jsRegistrationTask;
            }
            catch (ObjectDisposedException)
            {
            }
            catch (JSDisconnectedException)
            {
            }
        }

        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("clearObjectReference");
            }
            catch (ObjectDisposedException)
            {
            }
            catch (JSDisconnectedException)
            {
            }

            await _module.DisposeAsync();
        }

        _objectReference?.Dispose();
    }
}

@if (CurrentException != null)
{
    <div class="error-boundary">
        <div class="error-message">
            <h2>An error has occurred</h2>
            <p>@CurrentException.Message</p>
            <button @onclick="ResetError">Try Again</button>
        </div>
    </div>
}
else
{
    @ChildContent
}
